"""Scaffolding helpers for terminal-bench task directories."""

from __future__ import annotations

import textwrap
from dataclasses import dataclass
import re
from pathlib import Path

from ..config import get_logger

logger = get_logger(__name__)


DOCKERFILE_TEMPLATE = """\
# Generated by dvsmith terminal-bench builder
FROM ghcr.io/laude-institute/t-bench/python-3-13:20250620

WORKDIR /app

RUN apt-get update && apt-get install -y git patch && rm -rf /var/lib/apt/lists/*

# Clone the pinned repository commit directly into /app/repo
RUN git clone {repo_remote} /app/repo && \\
    cd /app/repo && \\
    git checkout {repo_commit}

COPY resources/ /tmp/resources/
RUN bash /tmp/resources/setup_repo.sh /app/repo && rm -rf /tmp/resources
"""

DOCKER_COMPOSE_TEMPLATE = """\
services:
  client:
    build:
      dockerfile: Dockerfile
    image: ${T_BENCH_TASK_DOCKER_CLIENT_IMAGE_NAME}
    container_name: ${T_BENCH_TASK_DOCKER_CLIENT_CONTAINER_NAME}
    command: [ "sh", "-c", "sleep infinity" ]
    environment:
      - TEST_DIR=${T_BENCH_TEST_DIR}
    volumes:
      - ${T_BENCH_TASK_LOGS_PATH}:${T_BENCH_CONTAINER_LOGS_PATH}
      - ${T_BENCH_TASK_AGENT_LOGS_PATH}:${T_BENCH_CONTAINER_AGENT_LOGS_PATH}
"""

RUN_TESTS_TEMPLATE = """\
#!/bin/bash
set -euo pipefail

if [ -z "${{TEST_DIR:-}}" ]; then
  echo "TEST_DIR is not set"
  exit 1
fi

python3 "$TEST_DIR/test_outputs.py"
"""

RESOURCES_SETUP_TEMPLATE = """\
#!/bin/bash
set -euo pipefail

TARGET_REPO="$1"

if [ ! -d "$TARGET_REPO" ]; then
  echo "Target repo '$TARGET_REPO' does not exist"
  exit 1
fi
"""

TASK_YAML_PLACEHOLDER = """\
instruction: |-
  TODO: Fill task instructions.
author_name: DV Smith
author_email: devnull@example.com
difficulty: medium
category: hardware-verification
tags: []
parser_name: pytest
max_agent_timeout_sec: 900
max_test_timeout_sec: 180
run_tests_in_same_shell: false
"""

PROMPT_PLACEHOLDER = """\
# TODO: Replace with final student-facing description

Provide a clear explanation of the verification challenge, constraints, and acceptance criteria.
"""

SOLUTION_PLACEHOLDER = """\
#!/bin/bash
set -euo pipefail

echo "TODO: provide reference solution patch or script"
"""


@dataclass
class TaskScaffold:
    """Represents a prepared task directory."""

    task_id: str
    path: Path
    task_type: str
    target: str | None = None


class TerminalBenchScaffolder:
    """Create baseline folder structure for terminal-bench tasks."""

    def __init__(
        self,
        base_dir: Path,
        remote_url: str,
        commit_sha: str,
    ) -> None:
        self.base_dir = Path(base_dir)
        self.remote_url = remote_url
        self.commit_sha = commit_sha

        if not self.remote_url:
            raise ValueError(
                "Remote URL is required to scaffold terminal-bench tasks (git ADD needs it)."
            )
        if not self.commit_sha:
            raise ValueError("Commit SHA is required to scaffold terminal-bench tasks.")

    def ensure_base(self) -> None:
        self.base_dir.mkdir(parents=True, exist_ok=True)

    def create_scaffold(
        self,
        task_id: str,
        task_type: str,
        target: str | None,
    ) -> TaskScaffold:
        """Create scaffold for a specific task."""

        task_dir = self.base_dir / task_id
        task_dir.mkdir(parents=True, exist_ok=True)

        self._write_file(task_dir / "Dockerfile", DOCKERFILE_TEMPLATE.format(
            repo_remote=self.remote_url,
            repo_commit=self.commit_sha,
        ))
        self._write_file(task_dir / "docker-compose.yaml", DOCKER_COMPOSE_TEMPLATE)
        self._write_file(task_dir / "run-tests.sh", RUN_TESTS_TEMPLATE)

        tests_dir = task_dir / "tests"
        tests_dir.mkdir(exist_ok=True)
        resources_dir = task_dir / "resources"
        resources_dir.mkdir(exist_ok=True)

        self._write_file(task_dir / "task.yaml", TASK_YAML_PLACEHOLDER)
        self._write_file(task_dir / "prompt.md", PROMPT_PLACEHOLDER)
        self._write_file(task_dir / "solution.sh", SOLUTION_PLACEHOLDER)
        self._write_file(resources_dir / "setup_repo.sh", RESOURCES_SETUP_TEMPLATE)

        # Ensure scripts are executable
        for script in [
            task_dir / "run-tests.sh",
            task_dir / "solution.sh",
            resources_dir / "setup_repo.sh",
        ]:
            script.chmod(0o755)

        return TaskScaffold(task_id=task_id, path=task_dir, task_type=task_type, target=target)

    def _write_file(self, path: Path, content: str) -> None:
        path.write_text(textwrap.dedent(content).lstrip("\n"))


def slugify(value: str) -> str:
    """Generate filesystem-friendly slug."""
    sanitized = "".join(ch if ch.isalnum() or ch in "-_" else "-" for ch in value.lower())
    sanitized = sanitized.strip("-_")
    sanitized = re.sub("-{2,}", "-", sanitized)
    return sanitized or "task"


__all__ = ["TerminalBenchScaffolder", "TaskScaffold", "slugify"]
